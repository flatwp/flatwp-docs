---
sidebar_position: 6
---

# WordPress Plugin

The FlatWP Companion plugin bridges WordPress with your Next.js frontend.

## Overview

FlatWP Companion is a WordPress plugin that enables seamless integration between WordPress CMS and Next.js headless frontends. It handles cache revalidation, preview mode, image optimization, and SEO synchronization.

## Features

### Cache Revalidation

Automatically triggers Next.js cache revalidation when content changes:

**Triggers**:
- Post published
- Post updated
- Post deleted
- Featured image changed
- Custom fields updated

**How it works**:
1. Editor saves content in WordPress
2. Plugin detects the change
3. Webhook sent to `/api/revalidate`
4. Next.js clears cache for affected paths
5. Next request fetches fresh data

### Preview Mode

Enable editors to preview draft and scheduled content:

**Features**:
- Time-limited preview tokens
- Secure preview URLs
- Draft content rendering
- Scheduled post preview

**Usage**:
1. Edit a draft post in WordPress
2. Click "Preview" button
3. Plugin generates secure token
4. Redirects to Next.js preview URL
5. Content rendered in draft mode

### Image Optimization

Generate blur placeholders for progressive image loading:

**Features**:
- Automatic base64 blur data generation
- Stored in image metadata
- Exposed via GraphQL
- Used by next/image

**Implementation**:
```graphql
query GetPost {
  post(id: "123") {
    featuredImage {
      node {
        sourceUrl
        blurDataURL  # Generated by plugin
        altText
      }
    }
  }
}
```

### SEO Integration

Sync metadata from popular SEO plugins:

**Supported Plugins**:
- Yoast SEO
- Rank Math
- All in One SEO
- SEOPress

**Synced Data**:
- Meta title
- Meta description
- Open Graph tags
- Twitter Card tags
- Canonical URLs
- Focus keywords

### GraphQL Extensions

Extends WPGraphQL with custom fields:

```graphql
type Post {
  # Standard fields
  id: ID!
  title: String
  content: String

  # FlatWP extensions
  blurPlaceholder: String
  seoMetadata: SEOData
  estimatedReadTime: Int
}
```

### Search Index Generation

Creates lightweight JSON search indexes:

**Features**:
- Auto-updates on content changes
- Optimized for Fuse.js
- Includes minimal metadata
- Cached for performance

**Usage**:
```typescript
// Generated at /search-index.json
const response = await fetch('/search-index.json');
const searchData = await response.json();

// Use with Fuse.js
import Fuse from 'fuse.js';
const fuse = new Fuse(searchData, {
  keys: ['title', 'excerpt']
});
```

## Installation

### Requirements

- WordPress 5.9+
- PHP 7.4+
- GD or Imagick extension
- WPGraphQL plugin (recommended)

### Install from GitHub

1. Download latest release from [GitHub](https://github.com/flatwp/flatwp-plugin/releases)
2. Upload ZIP via **Plugins → Add New → Upload Plugin**
3. Activate the plugin
4. Configure in **Settings → FlatWP**

### Install from WordPress.org

:::info Coming Soon
The plugin will be available on WordPress.org repository soon.
:::

## Configuration

### Connection Settings

Navigate to **Settings → FlatWP** in WordPress admin:

#### Next.js Site URL

```
Production: https://yoursite.com
Development: http://localhost:3000
Staging: https://staging.yoursite.com
```

This is where webhooks will be sent.

#### Revalidation Secret

```
Generate a secure random string:
$ openssl rand -base64 32

Must match REVALIDATION_SECRET in Next.js
```

Validates webhook authenticity.

#### Enable Webhooks

Check this box to enable automatic cache revalidation when content changes.

### Revalidation Settings

Configure which events trigger revalidation:

```
✓ Post published
✓ Post updated
✓ Post deleted
✓ Featured image changed
✓ Custom fields updated
□ Comment added (optional)
□ User profile updated (optional)
```

### Preview Settings

#### Enable Preview Mode

Check to enable draft content preview in Next.js.

#### Preview Token Expiry

```
Default: 3600 seconds (1 hour)
Range: 300-86400 seconds
```

How long preview tokens remain valid.

### Image Settings

#### Blur Placeholder Generation

```
✓ Enable automatic blur placeholder generation
Quality: 10 (1-100, lower = smaller file)
Size: 40x40 pixels (10-100)
```

#### Regenerate Placeholders

Bulk regenerate blur data for existing images:

```bash
# Via WP-CLI
wp flatwp regenerate-placeholders --batch-size=50

# Via admin interface
Tools → FlatWP → Regenerate Blur Placeholders
```

### SEO Settings

#### Auto-detect SEO Plugin

Plugin automatically detects and integrates with installed SEO plugins.

#### Manual Override

```
Primary SEO Plugin: [Auto-detect]
                    or select specific plugin

Fallback: Use WordPress defaults
```

## API Endpoints

The plugin provides several REST API endpoints:

### Health Check

```http
GET /wp-json/flatwp/v1/health

Response:
{
  "status": "ok",
  "version": "0.2.1",
  "features": {
    "revalidation": true,
    "preview": true,
    "blur_placeholders": true,
    "seo_sync": true
  }
}
```

### Settings Query

```http
GET /wp-json/flatwp/v1/settings

Response:
{
  "nextjs_url": "https://yoursite.com",
  "revalidation_enabled": true,
  "preview_enabled": true
}
```

### Preview Validation

```http
POST /wp-json/flatwp/v1/preview/validate
Content-Type: application/json

{
  "token": "preview-token-here",
  "post_id": 123
}

Response:
{
  "valid": true,
  "post_id": 123,
  "post_type": "post",
  "expires_at": "2024-12-05T12:00:00Z"
}
```

## GraphQL Extensions

### Blur Placeholder Field

```graphql
query GetPostWithBlur {
  post(id: "123") {
    featuredImage {
      node {
        sourceUrl
        blurDataURL  # Base64 blur data
        width
        height
      }
    }
  }
}
```

### SEO Metadata Field

```graphql
query GetPostWithSEO {
  post(id: "123") {
    seo {
      title
      metaDesc
      canonical
      opengraphTitle
      opengraphDescription
      opengraphImage {
        sourceUrl
      }
      twitterTitle
      twitterDescription
    }
  }
}
```

### Read Time Estimation

```graphql
query GetPostWithReadTime {
  post(id: "123") {
    title
    content
    estimatedReadTime  # Minutes to read
  }
}
```

## Development

### Testing Webhooks

Test revalidation manually:

```bash
# Test webhook locally
curl -X POST http://localhost:3000/api/revalidate \
  -H "Content-Type: application/json" \
  -d '{
    "secret": "your-revalidation-secret",
    "paths": ["/", "/blog"]
  }'

# Check webhook logs in WordPress
Tools → FlatWP → Webhook Logs
```

### Debugging

Enable debug mode in `wp-config.php`:

```php
define('FLATWP_DEBUG', true);
```

View logs:
- Admin interface: **Tools → FlatWP → Debug Logs**
- File: `/wp-content/flatwp-debug.log`

### Filters and Hooks

Customize plugin behavior with WordPress filters:

```php
// Modify revalidation paths
add_filter('flatwp_revalidation_paths', function($paths, $post_id) {
    $paths[] = '/custom-archive';
    return $paths;
}, 10, 2);

// Customize blur placeholder quality
add_filter('flatwp_blur_quality', function($quality) {
    return 15; // Default is 10
});

// Modify preview token expiry
add_filter('flatwp_preview_token_expiry', function($expiry) {
    return 7200; // 2 hours instead of 1
});
```

## Troubleshooting

### Webhooks Not Firing

**Check**:
1. Webhooks enabled in settings
2. Next.js URL is correct and accessible
3. Revalidation secret matches
4. WordPress can make outbound HTTP requests

**Test**:
```bash
# Check if WordPress can reach Next.js
curl -I https://yoursite.com/api/revalidate
```

### Blur Placeholders Not Generating

**Check**:
1. GD or Imagick extension installed
2. PHP memory limit sufficient (128MB+)
3. Image upload succeeded
4. Blur generation enabled in settings

**Regenerate**:
```bash
wp flatwp regenerate-placeholders --post-id=123
```

### Preview Mode Issues

**Check**:
1. Preview mode enabled
2. Token not expired
3. User has permission to edit posts
4. Next.js preview API route configured

### SEO Data Not Syncing

**Check**:
1. SEO plugin installed and active
2. GraphQL query includes `seo` field
3. Post has SEO data configured
4. Plugin version compatible

## Updates

### Check for Updates

```bash
# Via WP-CLI
wp plugin update flatwp-companion

# Via admin interface
Dashboard → Updates → Check for plugin updates
```

### Changelog

View version history on [GitHub Releases](https://github.com/flatwp/flatwp-plugin/releases).

## Support

### Documentation

- [GitHub Repository](https://github.com/flatwp/flatwp-plugin)
- [Issue Tracker](https://github.com/flatwp/flatwp-plugin/issues)
- [Discussions](https://github.com/flatwp/flatwp-starter/discussions)

### Community

- GitHub Discussions for questions
- GitHub Issues for bug reports
- Pull requests welcome

## Next Steps

- [Configuration](/docs/configuration) - Configure your integration
- [Deployment](/docs/deployment) - Deploy to production
- [Architecture](/docs/architecture) - Understand the system
